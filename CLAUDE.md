# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Story-Gen is a Gradio-based web application that generates videos from story ideas using Google's Gemini (LLM), Imagen (image generation), and Veo (video generation) models. The pipeline transforms text prompts into complete videos with optional audio narration.

## Running the Application

```bash
# Install dependencies using uv
uv sync

# Run the application
python main.py
```

The application launches on `http://0.0.0.0:8000` by default.

## Required Environment Variables

Create a `.env` file with the following variables:

```
# Required
GEMINI_API_KEY=<your-gemini-api-key>
PROJECT_ID=<your-gcp-project-id>
VEO_PROJECT_ID=<your-veo-project-id>
VEO_STORAGE_BUCKET=<your-gcs-bucket-name>

# Optional
LOCAL_STORAGE=tmp
DEFAULT_MODEL_ID=gemini-2.0-flash
GOOGLE_CLIENT_ID=<oauth-client-id>
GOOGLE_CLIENT_SECRET=<oauth-client-secret>
SECRET_KEY=<session-secret-key>
```

## Architecture

### Main Flow

The application follows a 5-tab workflow in `main.py`:

1. **‚ú® The Spark** (`ui/idea_tab.py`): User inputs story idea ‚Üí generates characters, setting, plot
2. **üé≠ The Cast** (`ui/story_tab.py`): Configure characters (1-6), setting, plot, scenes (1-12), duration (5-8s), style ‚Üí develop detailed scene breakdowns
3. **üé¨ The Shoot** (`ui/visual_storyboard_tab.py`): Generate videos from scenes, optionally generate audio narration
4. **üéûÔ∏è The Dailies** (`ui/short_ingredients_tab.py`): Review individual scene videos before merging
5. **üéä Premiere Night** (`ui/big_thing_tab.py`): View final merged video

### Handler Layer

Handlers in `handlers/` orchestrate the generation pipeline:

- **story_handlers.py**:
  - `generate_story()`: LLM generates characters/setting/plot from idea (uses `gemini-2.5-flash`)
  - `generate_character_images()`: Creates character portraits using Imagen 4.0
  - `develope_story()`: Creates scene-by-scene breakdown with image prompts, saves to `tmp/images/default/`

- **video_handlers.py**:
  - `generate_video()`: Iterates through scenes, uploads images to GCS, calls Veo model, downloads generated videos
  - Uses long-running operation polling pattern with `fetch_operation()`

- **audio_handlers.py**:
  - `generate_audio()`: Converts scene scripts to speech
  - `merge_audios()`: Combines audio tracks

- **ui_handlers.py**:
  - `show_images_and_prompts()`: Loads existing scenes from `tmp/images/default/`
  - `check_folder()`: Creates directories as needed

### Utility Layer

Core utilities in `utils/`:

- **llm.py**: Wraps Google Gemini API with `call_llm()`, handles JSON extraction from markdown code blocks
- **gen_image.py**: Wraps Imagen API for image generation
- **gen_video.py**:
  - Video generation via Veo 2.0 (`text_to_video()`, `image_to_video()`)
  - GCS file operations (`upload_local_file_to_gcs()`, `copy_gcs_file_to_local()`)
  - Video looping with FFmpeg crossfade (`make_video_cyclic()`)
- **video_ts.py**: Merges video clips using MoviePy (`merge_videos_moviepy()`)
- **ce_audio.py**: Audio generation utilities
- **prompt_templates.py**: System prompts for story generation and development
- **logger.py**: Logging configuration
- **acceptance.py**: Contains `to_snake_case()` for file naming

### Data Flow

1. User input ‚Üí `generate_story()` ‚Üí Gemini LLM ‚Üí structured JSON with characters/setting/plot
2. Characters + Setting + Plot ‚Üí `develope_story()` ‚Üí Gemini LLM ‚Üí JSON array of scenes with image/video prompts
3. Each scene saved as:
   - `tmp/images/default/scene_N.png` (generated by Imagen)
   - `tmp/images/default/scene_prompt_N.txt` (video generation prompt)
   - `tmp/images/default/scene_script_N.txt` (narration script)
4. Scene images ‚Üí uploaded to GCS ‚Üí Veo 2.0/3.0 ‚Üí videos downloaded to `tmp/default/`
5. Individual videos ‚Üí `merge_videos_moviepy()` ‚Üí `tmp/default/merged_video.mp4`

## Model Configuration

Video models are configured in `models/config.py`:
- Veo models: `veo-2.0-generate-001`
- Image models: `imagen-4.0-generate-preview-06-06`, `imagen-3.0-generate-002`, `imagen-3.0-fast-generate-001`
- Aspect ratios: `1:1`, `9:16`, `16:9`, `4:3`, `3:4`
- Resolution: `720p` or `1080p` (Veo 3.0 only)

Note: Veo 2.0 does not support audio generation, use Veo 3.0 for audio features.

## File Organization

- Temporary files stored in `tmp/` (configurable via `LOCAL_STORAGE`)
- Character images: `tmp/images/characters/`
- Scene images and prompts: `tmp/images/default/`
- Generated videos: `tmp/default/`
- Story JSON: `tmp/images/default/story.json`

## Key Technical Notes

- All LLM calls expect JSON responses wrapped in markdown code blocks (handled by `string_to_pjson()`)
- Video generation uses long-running operations with polling every 10s, max 30 retries (5 minutes timeout)
- GCS is used as intermediate storage for Veo model I/O
- Character generation supports up to 6 characters with individual portraits
- Scene count ranges from 1-12, duration 5-8 seconds per scene
- FFmpeg required for video looping functionality
